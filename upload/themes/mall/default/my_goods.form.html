{include file=member.header.html}
{$images_upload}
{$editor_upload}
{$build_editor}
<style>
.box_arr .table_btn { width: 222px; }
.box_arr .table_btn a { float: left; }
.box_arr .table_btn a.disable_spec { background: url({res file=images/member/btn.gif}) repeat 0 -1018px; float: right; }
.dialog_body{ border:0px; }
.add_spec .add_link { color:#919191; }
.add_spec .add_link:hover { color:red; }
add_spec h2 { padding-left: 10px; }
.width7{ width: 250px;}
.f_l{ float:left; }
.mls_id { width: 0; filter: alpha(opacity=0);opacity: 0; }


</style>
<script type="text/javascript">
//<!CDATA[
var SPEC = {$goods.spec_json};

function change_price(obj,num){
    //比率
     var rate =parseInt(obj.value);
     rate=rate*0.01;
     var price=document.getElementById("price").value;
     price=parseFloat(price);
     var final_price=0;
     final_price=price*rate;
     document.getElementById(num).value=number_format(final_price, 2);
  
}


function add_uploadedfile(file_data)
{
    if(file_data.instance == 'goods_image'){
        $('#goods_images').append('<li ectype="handle_pic" file_id="'+ file_data.file_id +'" thumbnail="{$site_url}/'+ file_data.thumbnail +'"><input type="hidden" value="'+ file_data.file_id +'" name="goods_file_id[]"/><div class="pic"><img src="{$site_url}/'+ file_data.thumbnail +'" width="55" height="55" alt="" /><div ectype="handler" class="bg"><p class="operation"><span class="cut_in" ectype="set_cover" ecm_title="{$lang.set_cover}"></span><span class="delete" ectype="drop_image" ecm_title="{$lang.drop}"></span></p></div></div></li>');
                trigger_uploader();
        if($('#big_goods_image').attr('src') == '{$goods.default_goods_image}'){
            set_cover(file_data.file_id);
        }
        if(GOODS_SWFU.getStats().files_queued == 0){
            window.setTimeout(function(){
                $('#uploader').hide();
                $('#open_uploader').find('.show').attr('class','hide');
            },4000);
        }
    }else if(file_data.instance == 'desc_image'){
        $('#desc_images').append('<li file_name="'+ file_data.file_name +'" file_path="'+ file_data.file_path +'" ectype="handle_pic" file_id="'+ file_data.file_id +'"><input type="hidden" name="desc_file_id[]" value="'+ file_data.file_id +'"><div class="pic" style="z-index: 2;"><img src="{$site_url}/'+ file_data.file_path +'" width="50" height="50" alt="'+ file_data.file_name +'" /></div><div ectype="handler" class="bg" style="z-index: 3;display:none"><img src="{$site_url}/'+ file_data.file_path +'" width="50" height="50" alt="'+ file_data.file_name +'" /><p class="operation"><a href="javascript:void(0);" class="cut_in" ectype="insert_editor" ecm_title="{$lang.insert_editor}"></a><span class="delete" ectype="drop_image" ecm_title="{$lang.drop}"></span></p><p class="name">'+ file_data.file_name +'</p></div></li>');
                trigger_uploader();
        if(EDITOR_SWFU.getStats().files_queued == 0){
            window.setTimeout(function(){
                $('#editor_uploader').hide();
            },5000);
        }
    }
}


function set_cover(file_id){
    if(typeof(file_id) == 'undefined'){
        $('#big_goods_image').attr('src','{$goods.default_goods_image}');
        return;
    }
    var obj = $('*[file_id="'+ file_id +'"]');
    $('*[file_id="'+ file_id +'"]').clone(true).prependTo('#goods_images');
    $('*[ectype="handler"]').hide();
    $('#big_goods_image').attr('src',obj.attr('thumbnail'));
    obj.remove();
}

$(function(){
     $('#goods_form').validate({
        errorPlacement: function(error, element){
            $(element).next('.field_notice').hide();
            $(element).after(error);
        },
        success       : function(label){
            label.addClass('validate_right').text('OK!');
        },
        onkeyup : false,
        rules : {
            goods_name : {
                required   : true
            },
            price      : {
                number     : true,
                required : true,
                min : 0
            },
            stock      : {
                digits    : true
            },
            cate_id    : {
                remote   : {
                    url  : 'index.php?app=my_goods&act=check_mgcate',
                    type : 'get',
                    data : {
                        cate_id : function(){
                            return $('#cate_id').val();
                        }
                    }
                }
            }
        },
        messages : {
            goods_name  : {
                required   : '{$lang.goods_name_empty}'
            },
            price       : {
                number     : '{$lang.number_only}',
                required : '{$lang.price_empty}',
                min : '{$lang.price_ge_0}'
            },
            stock       : {
                digits  : '{$lang.number_only}'
            },
            cate_id     : {
                remote  : '{$lang.select_leaf_category}'
            }
        }
    });
    // init cover
    set_cover($("#goods_images li:first-child").attr('file_id'));

    // init spec
    spec_update();
});
//]]>
</script>
<script type="text/javascript">var  uptoken_url="{$site_url}?app=uptoken&act=uptoken";</script>
<script type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="{res file=css/jjc_upload.css}">
<script type="text/javascript" src="{res file=upload/jquery.min.js}"></script>
<script type="text/javascript" src="{res file=upload/plupload/plupload.full.min.js}"></script>
<script type="text/javascript" src="{res file=upload/qiniu.js}"></script>
<div class="content">
  <div class="totline"></div>
  <div class="botline"></div>
  {include file=member.menu.html}
  <div id="right">
     {include file=member.submenu.html}    
        <div class="wrap">

            <div class="public" >
                <form method="post" id="goods_form">
                    <div class="information_index">

                        <div class="add_spec" ectype="dialog_contents" style="display: none">

                            <!--<form>-->
                            <h2>{$lang.edit}{$lang.specification}</h2>
                            <p>{$lang.note_for_add_spec_popup}</p>
                            <div class="table" ectype="spec_editor">
                                <ul class="th" style="width: 850px">
                                    <li><input col="spec_name_1" type="text" class="text width4" /></li>
                                    <li><input col="spec_name_2" type="text" class="text width4" /></li>
                                    <li class="distance1">{$lang.price}</li>
                                    <li class="distance1">{$lang.member_price_1}</li>
                                    <li class="distance1">{$lang.member_price_2}</li>
                                    <li class="distance1">{$lang.member_price_3}</li>
                                    <li class="distance1">{$lang.member_price_4}</li>
                                    <li class="distance1">{$lang.stock}</li>
                                    <li class="distance2">{$lang.sku}</li>
                                    <li class="distance3">{$lang.handle}</li>
                                </ul>
                                <ul class="td" ectype="spec_item" style="width: 850px">
                                    <li><input item="spec_1" type="text" class="text width4" /></li>
                                    <li><input item="spec_2" type="text" class="text width4" /></li>
                                     <li><input item="price" type="text" class="text width4" /></li>
                                    <li><input item="member_price_1" type="text" class="text width4" /></li>
                                    <li><input item="member_price_2" type="text" class="text width4" /></li>
                                    <li><input item="member_price_3" type="text" class="text width4" /></li>
                                    <li><input item="member_price_4" type="text" class="text width4" /></li>
                                    <li><input item="stock" type="text" class="text width4" /></li>
                                    <li><input item="sku" type="text" class="text width8" /><input item="spec_id" type="hidden" /></li>
                                    <li class="padding3">
                                        <span ectype="up_spec_item" class="up_btn"></span>
                                        <span ectype="down_spec_item" class="down_btn"></span>
                                        <span ectype="drop_spec_item" class="delete_btn"></span>
                                    </li>
                                </ul>
                                <ul>
                                    <li class="add"><a href="javascript:;" ectype="add_spec_item" class="add_link">{$lang.add_spec_item}</a></li>
                                </ul>
                            </div>
                            <div class="btn_wrap"><input ectype="save_spec" type="submit" class="btn" value="{$lang.save_spec}" /></div>
                            <!--</form>-->
                            <div style="position:relative">
                              <div class="add_spec_bottom"></div>
                            </div>
                        </div>

                        <h4>{$lang.mgcategory}</h4>
                        <div class="add_wrap">
                            <div class="assort">
                                <p class="txt">{$lang.mgcategory}: </p>
                                <p class="select" id="gcategory">
                                    <!-- {if $goods.cate_id} -->
                                    <span class="f_l">{$goods.cate_name|escape}</span>
                                    <a class="edit_gcategory btn" href="javascript:;">{$lang.edit}</a>
                                    <select style="display:none">
                                        <option>{$lang.select_pls}</option>
                                        {html_options options=$mgcategories}
                                    </select>
                                    <!-- {else} -->
                                    <select>
                                        <option>{$lang.select_pls}</option>
                                        {html_options options=$mgcategories}
                                    </select>
                                    <!-- {/if} -->
                                    <input type="text" id="cate_id" name="cate_id" value="{$goods.cate_id}" class="mls_id" />
                                    <input type="hidden" name="cate_name" value="{$goods.cate_name|escape}" class="mls_names" />
                                </p>
                            </div>
                            <div class="assort">
                                <p class="txt">{$lang.sgcategory}: </p>
                                <p class="select">
                                    <!--{if $goods._scates}-->
                                    <!--{foreach from=$goods._scates item=sgcate}-->
                                    <select name="sgcate_id[]" class="sgcategory">
                                        <option value="0">{$lang.select_pls}</option>
                                        {html_options options=$sgcategories selected=$sgcate.cate_id}
                                    </select>
                                    <!-- {/foreach} -->
                                    <!--{else}-->
                                    <select name="sgcate_id[]" class="sgcategory">
                                        <option value="0">{$lang.select_pls}</option>
                                        {html_options options=$sgcategories}
                                    </select>
                                    <!--{/if}-->

                                </p>
                                <p class="new_add">
                                    <a href="javascript:;" id="add_sgcategory" class="btn">{$lang.add_scategory}</a>
                                    <span>{$lang.note_for_sgcategory}</span>
                                </p>
                            </div>
                        </div>

                        <h4>{$lang.goods_base_info}</h4>
                        <div class="add_wrap" id="container_drop">

                            <div class="pic_list">
                                <div class="big_pic"><img id="big_goods_image" src="{$goods.default_goods_image}" width="300" height="300" alt="" /></div>
                                <div class="small_pic">
                                    <ul id="goods_images">
                                        <!--{foreach from=$goods_images item=goods_iamge}-->
                                        {if empty($goods_iamge.custom)}
                                            <li ectype="handle_pic" file_id="{$goods_iamge.file_id}" thumbnail="{$site_url}/{$goods_iamge.thumbnail}">
                                            <input type="hidden" name="goods_file_id[]" value="{$goods_iamge.file_id}">
                                            <div class="pic">
                                                <img src="{$site_url}/{$goods_iamge.thumbnail}" width="55" height="55" />
                                                <div ectype="handler" class="bg">
                                                        <p class="operation">
                                                            <span class="cut_in" ectype="set_cover" ecm_title="{$lang.set_cover}"></span>
                                                            <span class="delete" ectype="drop_image" ecm_title="{$lang.drop}"></span>
                                                        </p>
                                                </div>
                                            </div>
                                            </li>
                                        {else}
                                            <li ectype="handle_pic" file_id="{$goods_iamge.file_id}" thumbnail="{$goods_iamge.thumbnail}">
                                            <input type="hidden" name="goods_file_id[]" value="{$goods_iamge.file_id}">
                                            <div class="pic">
                                                <img src="{$goods_iamge.thumbnail}" width="55" height="55" />
                                                <div ectype="handler" class="bg">
                                                        <p class="operation">
                                                            <span class="cut_in" ectype="set_cover" ecm_title="{$lang.set_cover}"></span>
                                                            <span class="delete" ectype="drop_image" ecm_title="{$lang.drop}"></span>
                                                        </p>
                                                </div>
                                            </div>
                                            </li>

                                        {/if}
                                        <!--{/foreach}-->
                                    </ul>
                                    <div class="clear"></div>
                                </div>
                                <!-- <div class="upload_btn">
                                    <div class="upload" id="open_uploader"><b class="hide">{$lang.upload_goods_image}</b></div>
                                    <div class="upload_con" id="uploader" style="display:none">
                                        <div class="upload_con_top"></div>
                                        <div class="upload_wrap">
                                
                                            <ul>
                                                <li class="btn1">
                                                <div id="divSwfuploadContainer">
                                                    <div id="divButtonContainer">
                                                        <span id="spanButtonPlaceholder"></span>
                                                    </div>
                                                </div>
                                                </li>
                                                <li><iframe src="index.php?app=comupload&act=view_iframe&id={$id}&belong={$belong}&instance=goods_image" width="86" height="30" scrolling="no" frameborder="0"></iframe></li>
                                                <li id="open_remote" class="btn2">{$lang.rem_upload}</li>
                                            </ul>
                                            <div id="remote" class="upload_file" style="display:none">
                                            <iframe src="index.php?app=comupload&act=view_remote&id={$id}&belong={$belong}&instance=goods_image" width="272" height="39" scrolling="no" frameborder="0"></iframe>
                                            </div>
                                            <div id="goods_upload_progress"></div>
                                            <div class="upload_txt">
                                                <span>{$lang.note_for_upload}</span>
                                            </div>
                                
                                        </div>
                                        <div class="upload_con_bottom"></div>
                                    </div>
                                </div> -->
                                <!--start-->
                                <div class="upload_btn">
                                    <div class="upload" id="open_uploader">
                                        <b class="hide">开始上传图片</b>
                                        <div class="upload_con" id="uploader" style="display:none">
                                             <div class="upload_con_top"></div>
                                             <div class="upload_wrap">
                                                <ul>
                                                    <li class="btn1">
                                                        <a href="javascript:;" class="file">选择文件 
                                                            <input type="file" name="" id="pickfiles"> 
                                                        </a>
                                                    </li>
                                                    <li class="btn2">
                                                        <a href="javascript:;" class="remote_file"> 
                                                            远程地址    
                                                        </a>
                                                    </li>
                                                </ul>
                                                <div class="upload_txt"id="content_bar">
                                                    <div id="container" style="position: relative;"></div>
                                                    <span>{$lang.note_for_upload}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--end-->
                            </div>

                            <div class="products">
                                <ul>
                                    <li>
                                        <h2>{$lang.goods_name}: </h2>
                                        <div class="arrange"><input title="{$goods.goods_name|escape}" type="text" name="goods_name" value="{$goods.goods_name|escape}" class="text width_normal" /><span class="red">*</span></div>
                                    </li>
                                    <li>
                                        <h2>{$lang.brand}: </h2>
                                        <div class="arrange"><input type="text" name="brand" value="{$goods.brand|escape}" class="text width_normal" /></div>
                                    </li>
                                    <li>
                                        <h2>{$lang.tags}: </h2>
                                        <div class="arrange"><input type="text" name="tags" value="{$goods.tags|escape}" class="text width_normal" />
                                            <span class="gray">{$lang.goods_tags_note}</span></div>
                                    </li>
                                   
                                    <li>
                                        <h2  ectype="no_spec">{$lang.price}: </h2>
                                        <div class="arrange"  ectype="no_spec"><input name="spec_id" value="{$goods._specs.0.spec_id}" type="hidden" /><input  id="price"name="price" value="{$goods._specs.0.price}" type="text" class="text width_short" /></div>
                                    </li> 
                                    <li>
                                        <h2  ectype="no_spec">{$lang.member_price_1}: </h2>
                                        <div class="arrange"  ectype="no_spec"><input name="spec_id" value="{$goods._specs.0.spec_id}" type="hidden" /><input name="member_price_1" value="{$goods._specs.0.member_price_1}" type="text" class="text width_short"id="member_price_1" />
                                        &nbsp;折扣比率：<input style="width: 40px" type="text"class="text width_short"onblur="change_price(this,'member_price_1')" onkeyup="this.value=this.value.replace(/[^0-9]/g,'')" onafterpaste="this.value=this.value.replace(/[^0-9]/g,'')"maxlength="2">%</div>
                                    </li>
                                    <li>
                                        <h2  ectype="no_spec">{$lang.member_price_2}: </h2>
                                        <div class="arrange"  ectype="no_spec"><input name="spec_id" value="{$goods._specs.0.spec_id}" type="hidden" /><input name="member_price_2" value="{$goods._specs.0.member_price_2}" type="text" class="text width_short" id="member_price_2"/> &nbsp;折扣比率：<input style="width: 40px" type="text"class="text width_short" onblur="change_price(this,'member_price_2')"onkeyup="this.value=this.value.replace(/[^0-9]/g,'')" onafterpaste="this.value=this.value.replace(/[^0-9]/g,'')"maxlength="2">%</div>
                                    </li>
                                    <li>
                                        <h2  ectype="no_spec">{$lang.member_price_3}: </h2>
                                        <div class="arrange"  ectype="no_spec"><input name="spec_id" value="{$goods._specs.0.spec_id}" type="hidden" /><input name="member_price_3" value="{$goods._specs.0.member_price_3}" type="text" class="text width_short" id="member_price_3"/> &nbsp;折扣比率：<input style="width: 40px" type="text"class="text width_short" onblur="change_price(this,'member_price_3')"onkeyup="this.value=this.value.replace(/[^0-9]/g,'')" onafterpaste="this.value=this.value.replace(/[^0-9]/g,'')"maxlength="2">%</div>
                                    </li>
                                    <li>
                                        <h2  ectype="no_spec">{$lang.member_price_4}: </h2>
                                        <div class="arrange"  ectype="no_spec"><input name="spec_id" value="{$goods._specs.0.spec_id}" type="hidden" /><input name="member_price_4" value="{$goods._specs.0.member_price_4}" type="text" class="text width_short" id="member_price_4"/> &nbsp;折扣比率：<input style="width: 40px" type="text"class="text width_short" onblur="change_price(this,'member_price_4')"onkeyup="this.value=this.value.replace(/[^0-9]/g,'')" onafterpaste="this.value=this.value.replace(/[^0-9]/g,'')"maxlength="2">%</div>
                                    </li>
                                    <!--end-->

                                    <li ectype="no_spec">
                                        <h2>{$lang.stock}: </h2>
                                        <div class="arrange"><input name="stock" value="{$goods._specs.0.stock}" type="text" class="text width_short" /></div>
                                    </li>
                                    <li ectype="no_spec">
                                        <h2>{$lang.sku}: </h2>
                                        <div class="arrange"><input name="sku" value="{$goods._specs.0.sku}" type="text" class="text width_normal" /></div>
                                    </li>
                                    <li>
                                        <h2>{$lang.spec}: </h2>
                                        <div class="arrange">
                                            <div class="box_arr" ectype="no_spec"  style="display: none;">
                                                <p class="pos_btn"><a ectype="add_spec" href="javascript:;" class="add_btn">{$lang.enable_spec}</a></p>
                                                <p class="pos_txt">{$lang.note_for_add_spec}</p>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="box_arr" ectype="has_spec"  style="display: none; width: 450px">
                                            <table ectype="spec_result" border="1" >
                                                <tr>
                                                    <th col="spec_name_1">loading..</th>
                                                    <th col="spec_name_2">loading..</th>
                                                    <th col="price">{$lang.price}</th>
                                                    <th col="stock">{$lang.stock}</th>
                                                    <th col="sku">{$lang.sku}</th>
                                                    <th col="member_price_1">{$lang.member_price_1}</th>
                                                    <th col="member_price_2">{$lang.member_price_2}</th>
                                                    <th col="member_price_3">{$lang.member_price_3}</th>
                                                    <th col="member_price_4">{$lang.member_price_4}</th>
                                                </tr>
                                                <tr ectype="spec_item" style="display:none">
                                                    <th item="spec_1"></th>
                                                    <th item="spec_2"></th>
                                                    <th item="price"></th>
                                                    <th item="stock"></th>
                                                    <th item="sku"></th>
                                                    <th item="member_price_1"></th>
                                                    <th item="member_price_2"></th>
                                                    <th item="member_price_3"></th>
                                                    <th item="member_price_4"></th>
        
                                                </tr>
                                            </table>
                                            <p class="table_btn">
                                                <a ectype="edit_spec" href="javascript:;" class="add_btn edit_spec">{$lang.edit_spec}</a>
                                                <a ectype="disable_spec" href="javascript:;" class="add_btn disable_spec">{$lang.disable_spec}</a>
                                            </p>
                                        </div>
                                    </li>
                                    <li>
                                        <h2>{$lang.if_show}: </h2>
                                        <div class="arrange">
                                            <span class="distance">
                                                <label><input name="if_show" value="1" type="radio" {if $goods.if_show}checked="checked" {/if}/> {$lang.yes}</label>
                                                <label><input name="if_show" value="0" type="radio" {if !$goods.if_show}checked="checked" {/if}/> {$lang.no}</label>
                                            </span>
                                        </div>
                                    </li>
                                    <li>
                                        <h2>{$lang.recommended}: </h2>
                                        <div class="arrange">
                                            <span class="distance">
                                                <label><input name="recommended" value="1" {if $goods.recommended}checked="checked" {/if}type="radio" name="c2" /> {$lang.yes}</label>
                                                <label><input name="recommended" value="0" {if !$goods.recommended}checked="checked" {/if}type="radio" name="c2" /> {$lang.no}</label>
                                            </span>
                                            <span class="gray">{$lang.note_for_recommended}</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="clear"></div>
                        </div>

                        <div class="add_bewrite">
                            <h5>{$lang.description}</h5>
                            <div class="add_wrap">
                                <div class="editor">
                                    <div>
                                    <textarea name="description" id="description"  style="width:100%; height:400px;">
                                    {$goods.description|escape}
                                    </textarea>
                                    </div>
                                    <div style=" position: relative; top: 10px; z-index: 5;"><a class="btn3" id="open_editor_uploader">{$lang.uploadedfile}</a>
                                        <!-- <div class="upload_con" id="editor_uploader" style="display:none">
                                            <div class="upload_con_top"></div>
                                            <div class="upload_wrap">
                                        
                                                <ul>
                                                    <li>
                                                        <div id="divSwfuploadContainer">
                                                            <div id="divButtonContainer">
                                                                <span id="editor_upload_button"></span>
                                                            </div>
                                                        </div>
                                                    </li>
                                                    <li><iframe src="index.php?app=comupload&act=view_iframe&id={$id}&belong={$belong}&instance=desc_image" width="86" height="30" scrolling="no" frameborder="0"></iframe></li>
                                                    <li id="open_editor_remote" class="btn2">{$lang.rem_upload}</li>
                                                </ul>
                                                <div id="editor_remote" class="upload_file" style="display:none">
                                                <iframe src="index.php?app=comupload&act=view_remote&id={$id}&belong={$belong}&instance=desc_image" width="272" height="39" scrolling="no" frameborder="0"></iframe>
                                                </div>
                                                <div id="editor_upload_progress"></div>
                                                <div class="upload_txt">
                                                    <span>{$lang.note_for_upload}</span>
                                                </div>
                                        
                                            </div>
                                            <div class="upload_con_bottom"></div>
                                        </div> -->

                                        <!--start:::desc_img设置添加-->
                                        <div class="upload_con" id="editor_uploader" style="display:none">
                                             <div class="upload_con_top"></div>
                                             <div class="upload_wrap">
                                                <ul>
                                                    <li class="btn1">
                                                        <a href="javascript:;" class="file">选择文件 
                                                            <input type="file" name="" id="desc_pickfiles"> 
                                                        </a>
                                                    </li>
                                                    <li class="btn2">
                                                        <a href="javascript:;" class="remote_file"> 
                                                            远程地址    
                                                        </a>
                                                    </li>
                                                </ul>
                                                <div class="upload_txt"id="desc_content_bar">
                                                    <div id="container" style="position: relative;"></div>
                                                    <span>{$lang.note_for_upload}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <!--end-->
                                    </div>
                                    <ul id="desc_images" class="preview">
                                        <!--{foreach from=$desc_images item=desc_image}-->
                                        <li ectype="handle_pic" file_name="{$desc_image.file_name|escape}" file_path="{$desc_image.file_path}" file_id="{$desc_image.file_id}">
                                        <input type="hidden" name="desc_file_id[]" value="{$desc_image.file_id}">
                                            <div class="pic">
                                            <img src="{if strstr($desc_image.file_path,'http:')} {$desc_image.file_path} {else} {$site_url}/{$desc_image.file_path} {/if}" width="50" height="50" alt="{$desc_image.file_name|escape}" title="{$desc_image.file_name|escape}" /></div>
                                            <div ectype="handler" class="bg">
                                            <img src="{if strstr($desc_image.file_path,'http:')} {$desc_image.file_path} {else} {$site_url}/{$desc_image.file_path} {/if}" width="50" height="50" alt="{$desc_image.file_name|escape}" title="{$desc_image.file_name|escape}" /> <p class="operation">
                                                    <a class="cut_in" ectype="insert_editor" href="javascript:void(0);" ecm_title="{$lang.insert_editor}"></a>
                                                    <span class="delete" ectype="drop_image" ecm_title="{$lang.drop}"></span>
                                                </p>
                                                <p title="{$desc_image.file_name|escape}" class="name">{$desc_image.file_name|escape}</p>
                                            </div>
                                        </li>
                                        <!--{/foreach}-->
                                    </ul>
                                    <div class="clear"></div>
                                </div>
                                <div class="issuance"><input type="submit" class="btn" value="{$lang.submit}" /></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="wrap_bottom"></div>
        </div>

        <div class="clear"></div>
        <div class="adorn_right1"></div>
        <div class="adorn_right2"></div>
        <div class="adorn_right3"></div>
        <div class="adorn_right4"></div>
    </div>
    <div class="clear"></div>
</div>
    <style>
        .file {
    position: relative;
    display: inline-block;
    background: #D0EEFF;
    border: 1px solid #99D3F5;
    border-radius: 4px;
    padding: 4px 18px;
    overflow: hidden;
    color: #1E88C7;
    text-decoration: none;
    text-indent: 0;
    line-height: 24px;
}
.file input {
    position: absolute;
    font-size: 37px;
    right: 0;
    top: 0;
    opacity: 0;
}
.file:hover {
    background: #AADFFD;
    border-color: #78C3F3;
    color: #004974;
    text-decoration: none;
}
.remote_file{
        position: relative;
        display: inline-block;
        background: #D0EEFF;
        border: 1px solid #99D3F5;
        border-radius: 4px;
        padding: 4px 18px;
        overflow: hidden;
        color: #1E88C7;
        text-decoration: none;
        text-indent: 0;
        line-height: 24px;


    }
.remote_file:hover {
    background: #AADFFD;
    border-color: #78C3F3;
    color: #004974;
    text-decoration: none;
}
    </style>


<script type="text/javascript">
      
       $goods_path=$("#goods_images").children("li:first").attr("thumbnail");
       if($goods_path){
            $("#big_goods_image").attr({
                src: $goods_path
            });
       } 
        //引入Plupload 、qiniu.js后
        var temp_num=0;
        var img_arr=new Array();
        var uploader = Qiniu.uploader({
                            runtimes: 'html5,flash,html4',    //上传模式,依次退化
                            browse_button: 'pickfiles',       //上传选择的点选按钮，**必需**
                            uptoken_url: uptoken_url,            //Ajax请求upToken的Url，**强烈建议设置**（服务端提供）
                            // uptoken : '<Your upload token>', //若未指定uptoken_url,则必须指定 uptoken ,uptoken由其他程序生成
                            unique_names: true,
                            // unique_names: true, // 默认 false，key为文件名。若开启该选项，SDK为自动生成上传成功后的key（文件名）。
                            // save_key: true,   // 默认 false。若在服务端生成uptoken的上传策略中指定了 `sava_key`，则开启，SDK会忽略对key的处理
                            domain: 'http://oflmvdj34.bkt.clouddn.com/',   //bucket 域名，下载资源时用到，**必需**
                            get_new_uptoken: false,  //设置上传文件的时候是否每次都重新获取新的token
                            container: 'container',           //上传区域DOM ID，默认是browser_button的父元素，
                            max_file_size: '100mb',           //最大文件体积限制
                            flash_swf_url: 'js/plupload/Moxie.swf',  //引入flash,相对路径
                            max_retries: 3,                   //上传失败最大重试次数
                            dragdrop: true,                   //开启可拖曳上传
                            drop_element: 'container_drop',        //拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
                            chunk_size: '4mb',                //分块上传时，每片的体积
                            auto_start: true,                 //选择文件后自动上传，若关闭需要自己绑定事件触发上传
                            init: {
                                'FilesAdded': function(up, files) {
                                    plupload.each(files, function(file) {
                                        // 文件添加进队列后,处理相关的事情
                                        $("#open_uploader span").remove();
                                        var temp_id=file.id;
                                        console.log("1_"+temp_id);
                                        var val='<div><span style="float:left;" ectype="'+temp_id+'">'+file.name+'</span> <div class="progressbar" ectype="'+temp_id+'" id="'+temp_id+'" data-perc="100"> <div class="bar"> <span></span> </div> <div class="label"> <span></span> </div> </div></div>'
                                        $("#content_bar").append(val);
                                        //console.log(file);
                                        //alert(file.name);
                                        
                                    });
                                },
                                'BeforeUpload': function(up, file) {
                                   var chunk_size = plupload.parseSize(this.getOption('chunk_size'));
                                       // 每个文件上传前,处理相关的事情
                                },
                                'UploadProgress': function(up, file) {
                                   $("#"+file.id).attr("data-perc",file.percent);
                                  // alert(file.percent);
                                   temp_num++;
                                   //alert(file.percent);
                                   console.log(file);
                                   window.dong(temp_num);
                                   /*alert(file.status);
                                   if (parseInt(file.status)!=5) {
                                    alert("wozhixing le "+file.status);
                                    produceError(file.id);

                                   }*/
                                    
                                   /*alert(file.percent+"%");
                                   alert(file.speed+"s");
                                   alert(file.size);
                                  console.log(up);
                                  console.log(file);*/
                                       // 每个文件上传时,处理相关的事情
                                },
                                'FileUploaded': function(up, file, info) {
                                       // 每个文件上传成功后,处理相关的事情
                                       // 其中 info 是文件上传成功后，服务端返回的json，形式如
                                       // {
                                       //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                                       //    "key": "gogopher.jpg"
                                       //  }
                                       // 参考http://developer.qiniu.com/docs/v6/api/overview/up/response/simple-response.html

                                       // var domain =  up.getOption('domain');
                                       // var res = parseJSON(info);
                                       // var sourceLink = domain + res.key; 获取上传成功后的文件的Url
                                       var domain = up.getOption('domain');
                                       var resInfo = JSON.parse(info);
                                       sourceLink = domain + resInfo.key;
                                        $("#open_uploader span").remove();
                                        $("#"+file.id).remove();
                                       //img_arr[file.id]=sourceLink;
                                       var goods_image={};
                                       console.log(file);
                                       goods_image.file_id=file.id;
                                       goods_image.file_name=file.name;
                                       goods_image.file_size=file.size;
                                       goods_image.file_path=sourceLink;
                                       goods_image.thumbnail=sourceLink;
                                       goods_image.instance="goods_image";
                                       add_uploadedfile_re(goods_image);
                                },
                                'Error': function(up, err, errTip) {
                                    //var temp=up.getFile();
                                   $.each(up.files,function(i,n){
                                      
                                      produceError(n.id);
                                   })
                                    
                                    
                                    alert(errTip);

                                       //上传出错时,处理相关的事情
                                },
                                'UploadComplete': function() {
                                       //队列文件处理完毕后,处理相关的事情
                                },
                                'Key': function(up, file) {
                                    // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                                    // 该配置必须要在 unique_names: false , save_key: false 时才生效
                                    var key = "";
                                    // do something with key here
                                    return key;
                                }
                            }
                        });

                        // domain 为七牛空间（bucket)对应的域名，选择某个空间后，可通过"空间设置->基本设置->域名设置"查看获取

                        // uploader 为一个plupload对象，继承了所有plupload的方法，参考http://plupload.com/docs
</script>
<script type="text/javascript">
var prec_interval;
var store_id={$store_id};
function dong(temp_num) {      
    $('.progressbar').each(function(){
      var t = $(this),
      dataperc = t.attr('data-perc'),
      barperc = Math.round(dataperc*2);
      t.find('.bar').animate({width:barperc}, dataperc*2.8);
   
        t.find('.label').append('<div class="perc"></div>');
      

    function perc(){
        var length = t.find('.bar').css('width'),
        perc = Math.round(parseInt(length)/2),
        labelpos = (parseInt(length)-2);
        t.find('.label').css('left', labelpos);
        
          t.find('.perc').text(perc+'%');
        
         if (perc==100) {
            clearInterval(prec_interval);
            t.remove();
         }   
    }
    perc();
   prec_interval= setInterval(perc, 0); 
    });
        
    }
    function produceError(id){
        alert("chuli");
        console.log("2_"+id);
        $("[ectype='"+id+"']").remove();
             //$("*").hide();
}
function add_uploadedfile_re(file_data)
{
    if(file_data.instance == 'goods_image'){
        $('#goods_images').append('<li ectype="handle_pic" file_id="'+ file_data.file_id +'"thumbnail="'+ file_data.thumbnail +'"><input type="hidden" value="'+ file_data.file_id +'" name="goods_file_id[]"/><div class="pic"><img src="'+ file_data.thumbnail +'" width="55" height="55" alt="" /><div ectype="handler" class="bg"><p class="operation"><span class="cut_in" ectype="set_cover" ecm_title="{$lang.set_cover}"></span><span class="delete" ectype="drop_image" ecm_title="{$lang.drop}"></span></p></div></div></li>');
                trigger_uploader();
            /*将图片存入到数据库*/
        $.ajax({
            url: '{$site_url}?app=my_goods&act=save_img',
            type: 'post',
            dataType: 'json',
            data: {goods_id: {$id},image_url:file_data.thumbnail,thumbnail:file_data.thumbnail,sort_order:255,file_id:file_data.file_id},  
            success : function(result) {//返回数据根据结果进行相应的处理  
                        if ( result.success ) {  
                            $("#tipMsg").text("删除数据成功");  
                            tree.deleteItem("${org.id}", true);  
                        } else {  
                            $("#tipMsg").text("删除数据失败");  
                        }  
                    }                                                                                                                                                                
        })
        .done(function() {
            console.log("success");
        })
        .fail(function() {
            console.log("error");
        })
        .always(function() {
            console.log("complete");
        });

        /*if($('#big_goods_image').attr('src') == '{$goods.default_goods_image}'){
            set_cover(file_data.file_id);
        }*/
       /* if(GOODS_SWFU.getStats().files_queued == 0){
            window.setTimeout(function(){
                $('#uploader').hide();
                $('#open_uploader').find('.show').attr('class','hide');
            },4000);
        }*/
    }else if(file_data.instance == 'desc_image'){
        $('#desc_images').append('<li file_name="'+ file_data.file_name +'" file_path="'+ file_data.file_path +'" ectype="handle_pic" file_id="'+ file_data.file_id +'"><input type="hidden" name="desc_file_id[]" value="'+ file_data.file_id +'"><div class="pic" style="z-index: 2;"><img src="'+ file_data.file_path +'" width="50" height="50" alt="'+ file_data.file_name +'" /></div><div ectype="handler" class="bg" style="z-index: 3;display:none"><img src="'+ file_data.file_path +'" width="50" height="50" alt="'+ file_data.file_name +'" /><p class="operation"><a href="javascript:void(0);" class="cut_in" ectype="insert_editor" ecm_title="{$lang.insert_editor}"></a><span class="delete" ectype="drop_image" ecm_title="{$lang.drop}"></span></p><p class="name">'+ file_data.file_name +'</p></div></li>');
                trigger_uploader();
      /*  if(EDITOR_SWFU.getStats().files_queued == 0){
            window.setTimeout(function(){
                $('#editor_uploader').hide();
            },5000);
        }*/
         
        window.setTimeout(function(){
                $('#editor_uploader').hide();
            },5000);

        $.ajax({
            url: '{$site_url}?app=my_goods&act=save_store_img',
            type: 'POST',
            dataType: 'json',
            data: {
                  store_id  :  store_id,
                  image_url :  file_data.thumbnail,
                  goods_id  :  {$id},
                  belong    :  {$belong},
                  file_name :  file_data.file_name,
                  file_size :  file_data.file_size
                },
        })
        .done(function() {
            console.log("success");
        })
        .fail(function() {
            console.log("error");
        })
        .always(function() {
            console.log("complete");
        });
        
    }
}
</script>

<!-- desc_img上传图片设置 -->
<script type="text/javascript">
    var uploader = Qiniu.uploader({
                            runtimes: 'html5,flash,html4',    //上传模式,依次退化
                            browse_button: 'desc_pickfiles',       //上传选择的点选按钮，**必需**
                            uptoken_url: uptoken_url,            //Ajax请求upToken的Url，**强烈建议设置**（服务端提供）
                            // uptoken : '<Your upload token>', //若未指定uptoken_url,则必须指定 uptoken ,uptoken由其他程序生成
                            unique_names: true,
                            // unique_names: true, // 默认 false，key为文件名。若开启该选项，SDK为自动生成上传成功后的key（文件名）。
                            // save_key: true,   // 默认 false。若在服务端生成uptoken的上传策略中指定了 `sava_key`，则开启，SDK会忽略对key的处理
                            domain: 'http://oflmvdj34.bkt.clouddn.com/',   //bucket 域名，下载资源时用到，**必需**
                            get_new_uptoken: false,  //设置上传文件的时候是否每次都重新获取新的token
                            container: 'container',           //上传区域DOM ID，默认是browser_button的父元素，
                            max_file_size: '100mb',           //最大文件体积限制
                            flash_swf_url: 'js/plupload/Moxie.swf',  //引入flash,相对路径
                            max_retries: 3,                   //上传失败最大重试次数
                            dragdrop: true,                   //开启可拖曳上传
                            drop_element: 'container_drop',        //拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
                            chunk_size: '4mb',                //分块上传时，每片的体积
                            auto_start: true,                 //选择文件后自动上传，若关闭需要自己绑定事件触发上传
                            init: {
                                'FilesAdded': function(up, files) {
                                    plupload.each(files, function(file) {
                                        // 文件添加进队列后,处理相关的事情
                                        $("#desc_content_bar span").remove();
                                        var temp_id=file.id;
                                        console.log("1_"+temp_id);
                                        var val='<div><span style="float:left;" ectype="'+temp_id+'">'+file.name+'</span> <div class="progressbar" ectype="'+temp_id+'" id="'+temp_id+'" data-perc="100"> <div class="bar"> <span></span> </div> <div class="label"> <span></span> </div> </div></div>'
                                        $("#desc_content_bar").append(val);
                                        //console.log(file);
                                        //alert(file.name);
                                        
                                    });
                                },
                                'BeforeUpload': function(up, file) {
                                   var chunk_size = plupload.parseSize(this.getOption('chunk_size'));
                                       // 每个文件上传前,处理相关的事情
                                },
                                'UploadProgress': function(up, file) {
                                   $("#"+file.id).attr("data-perc",file.percent);
                                  // alert(file.percent);
                                   temp_num++;
                                   //alert(file.percent);
                                   console.log(file);
                                   window.dong(temp_num);
                                },
                                'FileUploaded': function(up, file, info) {
                                       // 每个文件上传成功后,处理相关的事情
                                       // 其中 info 是文件上传成功后，服务端返回的json，形式如
                                       // {
                                       //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                                       //    "key": "gogopher.jpg"
                                       //  }
                                       // 参考http://developer.qiniu.com/docs/v6/api/overview/up/response/simple-response.html

                                       // var domain =  up.getOption('domain');
                                       // var res = parseJSON(info);
                                       // var sourceLink = domain + res.key; 获取上传成功后的文件的Url
                                       var domain = up.getOption('domain');
                                       var resInfo = JSON.parse(info);
                                       sourceLink = domain + resInfo.key;
                                        $("#open_uploader span").remove();
                                        $("#"+file.id).remove();
                                       //img_arr[file.id]=sourceLink;
                                       var goods_image={};
                                       console.log(file);
                                       goods_image.file_id=file.id;
                                       goods_image.file_name=file.name;
                                       goods_image.file_size=file.size;
                                       goods_image.file_path=sourceLink;
                                       goods_image.thumbnail=sourceLink;
                                       goods_image.instance="desc_image";
                                       add_uploadedfile_re(goods_image);
                                },
                                'Error': function(up, err, errTip) {
                                    //var temp=up.getFile();
                                   $.each(up.files,function(i,n){
                                      
                                      produceError(n.id);
                                   })    
                                    alert(errTip);
                                       //上传出错时,处理相关的事情
                                },
                                'UploadComplete': function() {
                                       //队列文件处理完毕后,处理相关的事情
                                },
                                'Key': function(up, file) {
                                    // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                                    // 该配置必须要在 unique_names: false , save_key: false 时才生效
                                    var key = "";
                                    // do something with key here
                                    return key;
                                } 
                            }
                        });

                        // domain 为七牛空间（bucket)对应的域名，选择某个空间后，可通过"空间设置->基本设置->域名设置"查看获取

                        // uploader 为一个plupload对象，继承了所有plupload的方法，参考http://plupload.com/docs


</script>
    

{include file=footer.html}